<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Å©„ÅÜ„Å∂„Å§ÊñáÂ≠óÊé¢„Åó„Éë„Ç∫„É´ V9</title>
    <style>
        body {
            font-family: "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
            background-color: #e0f7fa;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
        }

        /* ÂÖ±ÈÄö„É¨„Ç§„Ç¢„Ç¶„Éà */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .screen.active {
            display: flex;
        }

        /* „Çø„Ç§„Éà„É´ÁîªÈù¢ */
        h1 {
            color: #006064;
            font-size: 32px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0px #fff;
        }

        .menu-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .menu-btn {
            width: 280px;
            padding: 12px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s, box-shadow 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.2;
        }

        .menu-btn span {
            font-size: 13px;
            opacity: 0.9;
            font-weight: normal;
        }

        .menu-btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }

        .btn-practice { background-color: #4caf50; }
        .btn-challenge-1 { background-color: #ff9800; }
        .btn-challenge-3 { background-color: #f44336; }

        /* „Ç≤„Éº„É†ÁîªÈù¢„Éò„ÉÉ„ÉÄ„Éº */
        #game-header {
            width: 95%;
            max-width: 500px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            padding: 0 10px;
            box-sizing: border-box;
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #quit-btn {
            background: #90a4ae;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
        }

        /* Êú¨Áï™Áî®„Çπ„Ç≥„Ç¢„Éª„Çø„Ç§„Éû„Éº */
        .challenge-info {
            display: none;
            font-weight: bold;
            font-size: 18px;
            color: #006064;
            background: rgba(255,255,255,0.8);
            padding: 5px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .timer-red { color: #d32f2f; animation: pulse 1s infinite; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* „Éí„É≥„Éà„Éª„Çπ„ÉÜ„Éº„Çø„Çπ„Ç®„É™„Ç¢ */
        #status-area {
            min-height: 50px;
            width: 95%;
            max-width: 600px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-bottom: 5px;
            padding: 5px;
        }

        .hint-card {
            background: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            border: 2px solid #b2ebf2;
            color: #333;
        }
        
        .hint-card.found {
            background-color: #d1e7dd;
            color: #0f5132;
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .hint-card.bonus {
            background-color: #fff9c4;
            border-color: #fbc02d;
            color: #f57f17;
            animation: popInCard 0.4s;
        }

        @keyframes popInCard {
            0% { transform: scale(0); }
            60% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* „Ç≤„Éº„É†Áõ§Èù¢ */
        #grid-wrapper {
            background: white;
            padding: 10px;
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            margin-bottom: 5px;
        }

        #grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            width: 85vw;
            max-width: 380px;
            aspect-ratio: 1;
        }

        .cell {
            background-color: #f8f9fa;
            border: 2px solid #cfd8dc;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 26px;
            font-weight: bold;
            color: #455a64;
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
        }

        .cell:active { transform: scale(0.95); }

        .cell.selected {
            background-color: #fff176 !important;
            border-color: #fbc02d !important;
            color: #f57f17 !important;
        }

        .cell.solved {
            background-color: #c8e6c9 !important;
            border-color: #43a047 !important;
            color: #1b5e20 !important;
        }

        /* Ê≥®Èáà„É°„ÉÉ„Çª„Éº„Ç∏ */
        #rule-note {
            font-size: 13px;
            color: #546e7a;
            margin-bottom: 10px;
            font-weight: bold;
            background: rgba(255,255,255,0.5);
            padding: 3px 10px;
            border-radius: 10px;
        }

        /* ‰∏ãÈÉ®„Ç≥„É≥„Éà„É≠„Éº„É´ */
        #bottom-controls {
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            gap: 15px;
        }

        #pass-btn {
            display: none;
            background-color: #78909c;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #546e7a;
        }
        
        #pass-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #546e7a;
        }

        #show-list-btn {
            display: none;
            background-color: #ff9800;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #e65100;
        }

        /* „É¢„Éº„ÉÄ„É´ÂÖ±ÈÄö */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 90%;
            width: 320px;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* „É™„Çπ„ÉàË°®Á§∫Áî® */
        #animal-list-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
            max-height: 50vh;
            overflow-y: auto;
        }
        .list-item {
            font-size: 14px;
            background: #f1f8e9;
            padding: 5px;
            border-radius: 8px;
        }

        .close-btn {
            margin-top: 20px;
            background: #607d8b;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
        }

        /* È£õ„Å≥Âá∫„Åô„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        #popup-anim {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 150px;
            pointer-events: none;
            z-index: 200;
            text-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        @keyframes popJump {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-30deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.5) rotate(10deg); opacity: 1; }
            70% { transform: translate(-50%, -50%) scale(1.2) rotate(0deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0) rotate(0deg); opacity: 0; }
        }

        /* ÁµêÊûúÁîªÈù¢ */
        .big-emoji { font-size: 60px; display: block; margin-bottom: 10px; }
        .score-display { font-size: 40px; font-weight: bold; color: #ff5722; margin: 5px 0; }
        .record-display { font-size: 16px; color: #006064; margin-bottom: 15px; font-weight: bold; }
        .new-record-badge { color: #f44336; font-weight: bold; animation: pulse 0.5s infinite; display: none;}
        
        #result-btn {
            background: #00bcd4;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 18px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }

        #next-level-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 18px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }

    </style>
</head>
<body>

    <!-- „Çø„Ç§„Éà„É´ÁîªÈù¢ -->
    <div id="title-screen" class="screen active">
        <h1>„Å©„ÅÜ„Å∂„Å§ÊñáÂ≠óÊé¢„Åó</h1>
        <div style="font-size: 80px; margin-bottom: 20px;">ü¶Åüê¥üê∞</div>
        
        <div class="menu-container">
            <button class="menu-btn btn-practice" onclick="startGame('practice', 0)">
                üî∞ „Çå„Çì„Åó„ÇÖ„ÅÜ
                <span>„Åò„Å£„Åè„Çä„ÅÇ„Åù„Å∂</span>
            </button>
            <button class="menu-btn btn-challenge-1" onclick="startGame('challenge', 60)">
                üî• 1„Å∑„Çì „Ç≥„Éº„Çπ
                <span>„Çµ„ÇØ„ÉÉ„Å®„ÉÅ„É£„É¨„É≥„Ç∏ÔºÅ</span>
            </button>
            <button class="menu-btn btn-challenge-3" onclick="startGame('challenge', 180)">
                üî•üî• 3„Å∑„Çì „Ç≥„Éº„Çπ
                <span>„Ç¨„ÉÉ„ÉÑ„É™„Åü„Åè„Åï„ÇìÔºÅ</span>
            </button>
        </div>
    </div>

    <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
    <div id="game-screen" class="screen">
        <div id="game-header">
            <div class="header-left">
                <button id="quit-btn" onclick="quitGame()">„ÇÑ„ÇÅ„Çã</button>
            </div>
            <div class="header-right">
                <!-- Êú¨Áï™Áî®ÊÉÖÂ†± -->
                <div id="timer-display" class="challenge-info">ÊÆã„Çä 60Áßí</div>
                <div id="score-display" class="challenge-info">0Âåπ</div>
            </div>
        </div>

        <!-- „Éí„É≥„Éà„Åæ„Åü„ÅØÁô∫Ë¶ãÊ∏à„ÅøË°®Á§∫„Ç®„É™„Ç¢ -->
        <div id="status-area"></div>

        <div id="grid-wrapper">
            <div id="grid-container"></div>
        </div>
        
        <!-- „É´„Éº„É´Ë™¨Êòé -->
        <div id="rule-note">‚Äª„Åä„Å™„Åò „Å™„Åæ„Åà„ÅÆ „Å©„ÅÜ„Å∂„Å§„ÅØ 1„Åã„ÅÑ „Å†„ÅëÔºÅ</div>

        <!-- ‰∏ãÈÉ®„Éú„Çø„É≥„Ç®„É™„Ç¢ -->
        <div id="bottom-controls">
            <button id="pass-btn" onclick="nextLevel()">„Éë„ÇπÔºà„Å§„Åé„Å∏Ôºâ</button>
            <button id="show-list-btn" onclick="showAnimalList()">üìñ „É™„Çπ„Éà</button>
        </div>
    </div>

    <!-- È£õ„Å≥Âá∫„Åô„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî® -->
    <div id="popup-anim"></div>

    <!-- „ÇØ„É™„Ç¢ÁîªÈù¢ÔºàÁ∑¥Áøí„É¢„Éº„ÉâÁî®Ôºâ -->
    <div id="practice-clear-modal" class="modal-overlay">
        <div class="modal-box">
            <span class="big-emoji">üéâ‚ú®</span>
            <h2>„ÇØ„É™„Ç¢ÔºÅ</h2>
            <p>„Åú„Çì„Å∂ „Åø„Å§„Åë„Åü„Å≠ÔºÅ</p>
            <button id="next-level-btn" onclick="nextLevel()">„Å§„Åé„ÅÆ „ÇÇ„Çì„Å†„ÅÑ</button>
        </div>
    </div>

    <!-- ÁµêÊûúÁîªÈù¢ÔºàÊú¨Áï™„É¢„Éº„ÉâÁî®Ôºâ -->
    <div id="result-modal" class="modal-overlay">
        <div class="modal-box">
            <span class="big-emoji">‚è∞üèÅ</span>
            <h2>„Åä„Åó„Åæ„ÅÑÔºÅ</h2>
            <p>„Åø„Å§„Åë„Åü „Å©„ÅÜ„Å∂„Å§</p>
            <div id="final-score" class="score-display">0Âåπ</div>
            <div class="record-display">„Åï„ÅÑ„Åì„ÅÜ„Åç„Çç„Åè: <span id="best-record">0</span>Âåπ <span id="new-record-badge" class="new-record-badge">NEW RECORD!</span></div>
            <button id="result-btn" onclick="quitGame()">„Çø„Ç§„Éà„É´„Å∏</button>
        </div>
    </div>

    <!-- ÂÖ®„É™„Çπ„ÉàË°®Á§∫„É¢„Éº„ÉÄ„É´ -->
    <div id="list-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>„ÅÑ„Åç„ÇÇ„ÅÆ„É™„Çπ„Éà</h3>
            <div id="animal-list-grid"></div>
            <button class="close-btn" onclick="closeAnimalList()">„Å®„Åò„Çã</button>
        </div>
    </div>

<script>
    // ÂãïÁâ©„Éá„Éº„Çø
    const animals = [
        { emoji: 'üê∂', name: '„ÅÑ„Å¨' }, { emoji: 'üê±', name: '„Å≠„Åì' },
        { emoji: 'üê≠', name: '„Å≠„Åö„Åø' }, { emoji: 'üêπ', name: '„ÅØ„ÇÄ„Åô„Åü„Éº' },
        { emoji: 'üê∞', name: '„ÅÜ„Åï„Åé' }, { emoji: 'ü¶ä', name: '„Åç„Å§„Å≠' },
        { emoji: 'üêª', name: '„Åè„Åæ' }, { emoji: 'üêº', name: '„Å±„Çì„Å†' },
        { emoji: 'üê®', name: '„Åì„ÅÇ„Çâ' }, { emoji: 'üêØ', name: '„Å®„Çâ' },
        { emoji: 'ü¶Å', name: '„Çâ„ÅÑ„Åä„Çì' }, { emoji: 'üêÆ', name: '„ÅÜ„Åó' },
        { emoji: 'üê∑', name: '„Å∂„Åü' }, { emoji: 'üê∏', name: '„Åã„Åà„Çã' },
        { emoji: 'üêµ', name: '„Åï„Çã' }, { emoji: 'üê¥', name: '„ÅÜ„Åæ' },
        { emoji: 'ü¶ì', name: '„Åó„Åæ„ÅÜ„Åæ' }, { emoji: 'üêë', name: '„Å≤„Å§„Åò' },
        { emoji: 'üêó', name: '„ÅÑ„ÅÆ„Åó„Åó' }, { emoji: 'üê∫', name: '„Åä„Åä„Åã„Åø' },
        { emoji: 'ü¶ç', name: '„Åî„Çä„Çâ' }, { emoji: 'üêò', name: '„Åû„ÅÜ' },
        { emoji: 'ü¶õ', name: '„Åã„Å∞' }, { emoji: 'ü¶í', name: '„Åç„Çä„Çì' },
        { emoji: 'ü¶å', name: '„Åó„Åã' }, { emoji: 'ü¶î', name: '„ÅØ„Çä„Å≠„Åö„Åø' },
        { emoji: 'üêø', name: '„Çä„Åô' }, { emoji: 'ü¶ù', name: '„ÅÇ„Çâ„ÅÑ„Åê„Åæ' },
        { emoji: 'üê´', name: '„Çâ„Åè„Å†' }, { emoji: 'ü¶®', name: '„Åô„Åã„Çì„Åè' },
        { emoji: 'ü¶¶', name: '„Åã„Çè„ÅÜ„Åù' }, { emoji: 'ü¶á', name: '„Åì„ÅÜ„ÇÇ„Çä' },
        { emoji: 'üêî', name: '„Å´„Çè„Å®„Çä' }, { emoji: 'üê§', name: '„Å≤„Çà„Åì' },
        { emoji: 'üêß', name: '„Å∫„Çì„Åé„Çì' }, { emoji: 'ü¶Ö', name: '„Çè„Åó' },
        { emoji: 'ü¶â', name: '„Åµ„Åè„Çç„ÅÜ' }, { emoji: 'ü¶Ü', name: '„Åã„ÇÇ' },
        { emoji: 'ü¶©', name: '„Åµ„Çâ„Åø„Çì„Åî' }, { emoji: 'ü¶¢', name: '„ÅØ„Åè„Å°„Çá„ÅÜ' },
        { emoji: 'ü¶ú', name: '„Åä„ÅÜ„ÇÄ' },
        { emoji: 'üêç', name: '„Å∏„Å≥' }, { emoji: 'üê¢', name: '„Åã„ÇÅ' },
        { emoji: 'üêä', name: '„Çè„Å´' }, { emoji: 'ü¶é', name: '„Å®„Åã„Åí' },
        { emoji: 'ü¶ã', name: '„Å°„Çá„ÅÜ„Å°„Çá' }, { emoji: 'üêõ', name: '„ÅÇ„Åä„ÇÄ„Åó' },
        { emoji: 'üêú', name: '„ÅÇ„Çä' }, { emoji: 'üêù', name: '„ÅØ„Å°' },
        { emoji: 'üêû', name: '„Å¶„Çì„Å®„ÅÜ„ÇÄ„Åó' }, { emoji: 'üêå', name: '„Åã„Åü„Å§„ÇÄ„Çä' },
        { emoji: 'üê≥', name: '„Åè„Åò„Çâ' }, { emoji: 'üê¨', name: '„ÅÑ„Çã„Åã' },
        { emoji: 'üêü', name: '„Åï„Åã„Å™' }, { emoji: 'ü¶à', name: '„Åï„ÇÅ' },
        { emoji: 'üêô', name: '„Åü„Åì' }, { emoji: 'ü¶ë', name: '„ÅÑ„Åã' },
        { emoji: 'ü¶ê', name: '„Åà„Å≥' }, { emoji: 'ü¶Ä', name: '„Åã„Å´' },
        { emoji: 'ü¶ñ', name: '„Åç„Çá„ÅÜ„Çä„ÇÖ„ÅÜ' }, { emoji: 'ü¶Ñ', name: '„ÇÜ„Å´„Åì„Éº„Çì' },
        { emoji: 'üëª', name: '„Åä„Å∞„Åë' }
    ];

    const hiraganaChars = "„ÅÇ„ÅÑ„ÅÜ„Åà„Åä„Åã„Åç„Åè„Åë„Åì„Åï„Åó„Åô„Åõ„Åù„Åü„Å°„Å§„Å¶„Å®„Å™„Å´„Å¨„Å≠„ÅÆ„ÅØ„Å≤„Åµ„Å∏„Åª„Åæ„Åø„ÇÄ„ÇÅ„ÇÇ„ÇÑ„ÇÜ„Çà„Çâ„Çä„Çã„Çå„Çç„Çè„Çí„Çì";
    const gridSize = 5;

    let currentMode = 'practice';
    let gameDuration = 60; // Áßí
    let gridData = [];
    let targetAnimals = []; 
    let foundAnimals = [];
    let selectedCells = [];
    
    // Êú¨Áï™Áî®Â§âÊï∞
    let totalScore = 0;
    let timeRemaining = 0;
    let timerInterval = null;

    // DOMË¶ÅÁ¥†
    const titleScreen = document.getElementById('title-screen');
    const gameScreen = document.getElementById('game-screen');
    const gridContainer = document.getElementById('grid-container');
    const statusArea = document.getElementById('status-area');
    const practiceClearModal = document.getElementById('practice-clear-modal');
    const resultModal = document.getElementById('result-modal');
    const listModal = document.getElementById('list-modal');
    const popupAnim = document.getElementById('popup-anim');
    
    const timerDisplay = document.getElementById('timer-display');
    const scoreDisplay = document.getElementById('score-display');
    const finalScore = document.getElementById('final-score');
    const bestRecordDisplay = document.getElementById('best-record');
    const newRecordBadge = document.getElementById('new-record-badge');
    
    const passBtn = document.getElementById('pass-btn');
    const showListBtn = document.getElementById('show-list-btn');

    // ÂäπÊûúÈü≥
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if (type === 'tap') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, now);
            gainNode.gain.setValueAtTime(0.1, now);
            osc.start();
            osc.stop(now + 0.05);
        } else if (type === 'pop') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.linearRampToValueAtTime(800, now + 0.1);
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.linearRampToValueAtTime(0, now + 0.2);
            osc.start();
            osc.stop(now + 0.2);
        } else if (type === 'bonus') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(800, now);
            osc.frequency.setValueAtTime(1200, now + 0.1);
            gainNode.gain.setValueAtTime(0.1, now);
            gainNode.gain.linearRampToValueAtTime(0, now + 0.2);
            osc.start();
            osc.stop(now + 0.2);
        } else if (type === 'level_clear') {
            [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                const osc2 = audioCtx.createOscillator();
                const gain2 = audioCtx.createGain();
                osc2.connect(gain2);
                gain2.connect(audioCtx.destination);
                osc2.type = 'square';
                osc2.frequency.value = freq;
                gain2.gain.setValueAtTime(0.1, now + i*0.1);
                gain2.gain.exponentialRampToValueAtTime(0.01, now + i*0.1 + 0.4);
                osc2.start(now + i*0.1);
                osc2.stop(now + i*0.1 + 0.4);
            });
        } else if (type === 'finish') {
            // Êòé„Çã„ÅÑÁµÇ‰∫ÜÈü≥
            [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                const osc2 = audioCtx.createOscillator();
                const gain2 = audioCtx.createGain();
                osc2.connect(gain2);
                gain2.connect(audioCtx.destination);
                osc2.type = 'triangle';
                osc2.frequency.value = freq;
                gain2.gain.setValueAtTime(0.1, now);
                gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.8);
                osc2.start(now);
                osc2.stop(now + 0.8);
            });
        }
    }

    // „Ç≤„Éº„É†ÈñãÂßã
    function startGame(mode, duration) {
        currentMode = mode;
        gameDuration = duration;
        
        titleScreen.classList.remove('active');
        gameScreen.classList.add('active');
        
        // UIÂàùÊúüÂåñ
        const isChallenge = (mode === 'challenge');
        document.querySelectorAll('.challenge-info').forEach(el => el.style.display = isChallenge ? 'block' : 'none');
        passBtn.style.display = isChallenge ? 'block' : 'none';
        showListBtn.style.display = isChallenge ? 'block' : 'none';

        if (isChallenge) {
            totalScore = 0;
            timeRemaining = duration;
            scoreDisplay.textContent = totalScore + 'Âåπ';
            updateTimerDisplay();
            startTimer();
        }

        nextLevel();
    }

    // „Çø„Ç§„Éû„ÉºÁÆ°ÁêÜ
    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();
            if (timeRemaining <= 0) {
                finishGame();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const min = Math.floor(timeRemaining / 60);
        const sec = timeRemaining % 60;
        const timeText = min > 0 ? `${min}ÂàÜ${sec}Áßí` : `${sec}Áßí`;
        timerDisplay.textContent = 'ÊÆã„Çä ' + timeText;
        
        if (timeRemaining <= 10) {
            timerDisplay.classList.add('timer-red');
        } else {
            timerDisplay.classList.remove('timer-red');
        }
    }

    // Ë®òÈå≤„ÅÆ‰øùÂ≠ò„Å®ÂèñÂæóÔºàLocal StorageÔºâ
    function getHighScore(duration) {
        const key = `animal_puzzle_v9_record_${duration}`;
        return parseInt(localStorage.getItem(key)) || 0;
    }

    function saveHighScore(duration, score) {
        const key = `animal_puzzle_v9_record_${duration}`;
        const current = getHighScore(duration);
        if (score > current) {
            localStorage.setItem(key, score);
            return true; // Êõ¥Êñ∞„Åó„Åü
        }
        return false;
    }

    function finishGame() {
        clearInterval(timerInterval);
        playSound('finish');
        
        finalScore.textContent = totalScore + 'Âåπ';
        
        // Ë®òÈå≤Êõ¥Êñ∞„ÉÅ„Çß„ÉÉ„ÇØ
        const isNewRecord = saveHighScore(gameDuration, totalScore);
        const bestScore = getHighScore(gameDuration);
        
        bestRecordDisplay.textContent = bestScore;
        
        if (isNewRecord) {
            newRecordBadge.style.display = 'inline';
        } else {
            newRecordBadge.style.display = 'none';
        }

        resultModal.style.display = 'flex';
    }

    function quitGame() {
        if (timerInterval) clearInterval(timerInterval);
        practiceClearModal.style.display = 'none';
        resultModal.style.display = 'none';
        listModal.style.display = 'none';
        gameScreen.classList.remove('active');
        titleScreen.classList.add('active');
    }

    // Ê¨°„ÅÆ„É¨„Éô„É´„Å∏
    function nextLevel() {
        practiceClearModal.style.display = 'none';
        selectedCells = [];
        foundAnimals = [];
        gridContainer.innerHTML = '';
        statusArea.innerHTML = '';

        let success = false;
        let attempts = 0;
        // ÈÖçÁΩÆË©¶Ë°å
        while (!success && attempts < 100) {
            success = generateLevel();
            attempts++;
        }
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        if(!success) {
            generateLevel(true);
        }

        renderGrid();
        updateStatusArea();
    }

    // Áõ§Èù¢ÁîüÊàê
    function generateLevel(fallback = false) {
        let grid = Array(gridSize).fill(null).map(() => Array(gridSize).fill(null));
        let shuffled = [...animals].sort(() => 0.5 - Math.random());
        let targets = [];
        let count = fallback ? 3 : (Math.random() > 0.4 ? 4 : 3);
        
        const isPractice = (currentMode === 'practice' || fallback);

        for (let animal of shuffled) {
            if (targets.length >= count) break;
            
            let path = findPathForWord(grid, animal.name, isPractice);
            if (path) {
                path.forEach((pos, index) => {
                    grid[pos.r][pos.c] = animal.name[index];
                });
                targets.push(animal);
            }
        }
        if (targets.length < 3) return false;

        targetAnimals = targets;
        
        for (let r = 0; r < gridSize; r++) {
            for (let c = 0; c < gridSize; c++) {
                if (grid[r][c] === null) {
                    grid[r][c] = hiraganaChars[Math.floor(Math.random() * hiraganaChars.length)];
                }
            }
        }
        gridData = grid;
        return true;
    }

    function findPathForWord(grid, word, isPractice) {
        let tryList = [];

        if (isPractice) {
            for(let i=0; i<50; i++) {
                tryList.push({r: Math.floor(Math.random()*gridSize), c: Math.floor(Math.random()*gridSize)});
            }
        } else {
            let startPoints = [];
            for(let r=0; r<gridSize; r++) {
                for(let c=0; c<gridSize; c++) {
                    if (grid[r][c] === word[0]) startPoints.unshift({r, c});
                    else if (grid[r][c] === null) startPoints.push({r, c});
                }
            }
            let priority = startPoints.filter(p => grid[p.r][p.c] === word[0]);
            let others = startPoints.filter(p => grid[p.r][p.c] !== word[0]).sort(() => 0.5 - Math.random());
            tryList = [...priority, ...others].slice(0, 50);
        }

        for (let start of tryList) {
             let path = solvePath(grid, word, 0, start.r, start.c, [], isPractice);
             if (path) return path;
        }
        return null;
    }

    function solvePath(grid, word, index, r, c, currentPath, isPractice) {
        if (r < 0 || r >= gridSize || c < 0 || c >= gridSize) return null;
        if (currentPath.some(p => p.r === r && p.c === c)) return null;
        if (grid[r][c] !== null && grid[r][c] !== word[index]) return null;
        
        const newPath = [...currentPath, {r, c}];
        if (index === word.length - 1) return newPath;

        let directions = [{dr:0,dc:1}, {dr:0,dc:-1}, {dr:1,dc:0}, {dr:-1,dc:0}];
        directions.sort(() => 0.5 - Math.random());

        if (!isPractice) {
            const nextChar = word[index + 1];
            directions.sort((a, b) => {
                let valA = getCellPriority(grid, r+a.dr, c+a.dc, nextChar);
                let valB = getCellPriority(grid, r+b.dr, c+b.dc, nextChar);
                return valB - valA;
            });
        }

        for (let dir of directions) {
            let res = solvePath(grid, word, index + 1, r + dir.dr, c + dir.dc, newPath, isPractice);
            if (res) return res;
        }
        return null;
    }

    function getCellPriority(grid, r, c, targetChar) {
        if (r < 0 || r >= gridSize || c < 0 || c >= gridSize) return -1;
        if (grid[r][c] === targetChar) return 2;
        if (grid[r][c] === null) return 1;
        return 0;
    }

    function renderGrid() {
        gridContainer.innerHTML = '';
        for (let r = 0; r < gridSize; r++) {
            for (let c = 0; c < gridSize; c++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.textContent = gridData[r][c];
                cell.onclick = () => handleCellClick(r, c, cell);
                gridContainer.appendChild(cell);
            }
        }
    }

    function updateStatusArea() {
        statusArea.innerHTML = '';
        if (currentMode === 'practice') {
            targetAnimals.forEach(animal => {
                const isFound = foundAnimals.includes(animal.name);
                const div = document.createElement('div');
                div.className = `hint-card ${isFound ? 'found' : ''}`;
                div.textContent = `${animal.emoji} ${animal.name}`;
                statusArea.appendChild(div);
            });
            foundAnimals.forEach(name => {
                if (!targetAnimals.some(t => t.name === name)) {
                    const animal = animals.find(a => a.name === name);
                    const div = document.createElement('div');
                    div.className = 'hint-card bonus';
                    div.textContent = `${animal.emoji} ${animal.name}`;
                    statusArea.appendChild(div);
                }
            });

        } else {
            if (foundAnimals.length === 0) {
                statusArea.innerHTML = '<div style="color:#666; font-size:14px;">„ÅÑ„Åç„ÇÇ„ÅÆ„Çí „Åï„Åå„Åó„Å¶„Å≠ÔºÅ</div>';
            } else {
                foundAnimals.forEach(name => {
                    const animal = animals.find(a => a.name === name);
                    const div = document.createElement('div');
                    div.className = 'hint-card bonus';
                    div.textContent = `${animal.emoji} ${animal.name}`;
                    statusArea.appendChild(div);
                });
            }
        }
    }

    function handleCellClick(r, c, cellElement) {
        if (selectedCells.length === 0) {
            playSound('tap');
            selectCell(r, c, cellElement);
        } else {
            const last = selectedCells[selectedCells.length - 1];
            if (last.r === r && last.c === c) {
                resetSelection();
                return;
            }
            const isAdjacent = (Math.abs(last.r - r) + Math.abs(last.c - c)) === 1;
            if (isAdjacent) {
                playSound('tap');
                selectCell(r, c, cellElement);
            } else {
                resetSelection();
                playSound('tap');
                selectCell(r, c, cellElement);
            }
        }
        checkAnswer();
    }

    function selectCell(r, c, el) {
        selectedCells.push({ r, c, char: gridData[r][c], element: el });
        el.classList.add('selected');
    }

    function resetSelection() {
        selectedCells.forEach(item => {
            item.element.classList.remove('selected');
        });
        selectedCells = [];
    }

    function checkAnswer() {
        const currentString = selectedCells.map(item => item.char).join('');
        const match = animals.find(a => a.name === currentString);

        if (match && !foundAnimals.includes(match.name)) {
            foundAnimals.push(match.name);
            
            const isTarget = targetAnimals.some(t => t.name === match.name);
            if (isTarget) {
                playSound('pop');
            } else {
                playSound('bonus');
            }

            if (currentMode === 'challenge') {
                totalScore++;
                scoreDisplay.textContent = totalScore + 'Âåπ';
            }
            
            selectedCells.forEach(item => {
                item.element.classList.remove('selected');
                item.element.classList.add('solved');
            });
            selectedCells = [];

            triggerPopupAnimation(match.emoji);
            updateStatusArea();
            checkLevelComplete();
        }
    }

    function checkLevelComplete() {
        const allTargetsFound = targetAnimals.every(t => foundAnimals.includes(t.name));
        if (allTargetsFound) {
            playSound('level_clear');
            if (currentMode === 'practice') {
                setTimeout(() => { practiceClearModal.style.display = 'flex'; }, 800);
            } else {
                setTimeout(() => { nextLevel(); }, 1000);
            }
        }
    }

    function triggerPopupAnimation(emoji) {
        popupAnim.style.animation = 'none';
        popupAnim.offsetHeight;
        popupAnim.textContent = emoji;
        popupAnim.style.animation = 'popJump 0.8s ease-out forwards';
    }

    function showAnimalList() {
        const listGrid = document.getElementById('animal-list-grid');
        listGrid.innerHTML = '';
        animals.forEach(animal => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.textContent = `${animal.emoji} ${animal.name}`;
            listGrid.appendChild(div);
        });
        listModal.style.display = 'flex';
    }

    function closeAnimalList() {
        listModal.style.display = 'none';
    }

</script>
</body>
</html>